<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Dokumen (Supabase) - Admin Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- UMD Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">ðŸ“‚ Sistem Manajemen Dokumen</h1>
        <p class="text-sm text-slate-600">Lihat dokumen â€” Admin dapat login untuk upload</p>
      </div>
      <div id="authArea" class="flex items-center gap-3">
        <!-- Will be filled by JS -->
      </div>
    </header>

    <!-- Upload area (only visible to logged-in admin) -->
    <div id="adminPanel" class="hidden bg-white shadow rounded p-4 mb-6">
      <h2 class="font-semibold mb-3">Upload Dokumen (Admin)</h2>
      <div class="grid gap-3">
        <input id="title" class="border rounded px-3 py-2" placeholder="Judul (required)" />
        <input id="category" class="border rounded px-3 py-2" placeholder="Kategori" />
        <textarea id="description" class="border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
        <input id="file" type="file" class="border rounded px-3 py-2 bg-white" />
        <div class="flex gap-3">
          <button id="btnUpload" class="bg-indigo-600 text-white px-4 py-2 rounded">Upload</button>
          <button id="btnLogout" class="border px-4 py-2 rounded">Logout</button>
        </div>
        <p id="adminNote" class="text-xs text-slate-500">Hanya PDF/gambar/office files. Ukuran bergantung pada bucket limit.</p>
      </div>
    </div>

    <!-- Document list -->
    <main class="bg-white p-4 rounded shadow">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-semibold">Daftar Dokumen</h2>
        <input id="search" class="border rounded px-3 py-2" placeholder="Cari judul atau deskripsi..." />
      </div>
      <div id="list" class="space-y-3"></div>
    </main>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://axyqczuoklugkwqediaf.supabase.co"; // ganti jika perlu
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4eXFjenVva2x1Z2t3cWVkaWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTA1OTIsImV4cCI6MjA3Nzk4NjU5Mn0.JhVQShNjueYqdSAKJNy1uGmyfbc5s7bn_17IzZ-B718"; // ganti dengan anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== UI elements ======
    const adminPanel = document.getElementById('adminPanel');
    const authArea = document.getElementById('authArea');
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');

    // ====== Auth UI helpers ======
    function renderAuthUI(user) {
      authArea.innerHTML = '';
      if (!user) {
        // show login form
        authArea.innerHTML = `
          <input id="loginEmail" class="border rounded px-3 py-1" placeholder="admin email" />
          <input id="loginPass" type="password" class="border rounded px-3 py-1" placeholder="password" />
          <button id="btnLogin" class="bg-indigo-600 text-white px-3 py-1 rounded">Login</button>
        `;
        document.getElementById('btnLogin').onclick = doLogin;
        adminPanel.classList.add('hidden');
      } else {
        // show user email + logout
        authArea.innerHTML = `
          <div class="text-sm text-slate-700">Signed in: <strong>${escapeHtml(user.email)}</strong></div>
        `;
        adminPanel.classList.remove('hidden');
      }
    }

    // ====== Escape helper ======
    function escapeHtml(s) {
      if (!s) return "";
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    // ====== Auth actions ======
    async function doLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPass').value;
      if (!email || !password) return alert('Isi email & password admin.');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert('Login gagal: ' + error.message);
      // logged-in â€” re-render
      const session = data?.user;
      renderAuthUI(data.user);
      loadDocuments(); // now admin view allowed
    }

    async function doLogout() {
      await supabase.auth.signOut();
      renderAuthUI(null);
      adminPanel.classList.add('hidden');
    }

    // attach logout button after DOM ready
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'btnLogout') doLogout();
    });

    // ====== Upload ======
    async function uploadDocument() {
      // require logged in user
      const user = supabase.auth.getUser ? (await supabase.auth.getUser()).data?.user : null;
      if (!user) {
        alert('Harap login sebagai admin untuk meng-upload.');
        return;
      }

      const title = document.getElementById('title').value.trim();
      const category = document.getElementById('category').value.trim();
      const description = document.getElementById('description').value.trim();
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];
      if (!title || !file) return alert('Judul dan file wajib diisi.');

      // file path (unique)
      const filePath = `${Date.now()}_${file.name}`;

      // upload to storage (bucket 'documents')
      const { data: uploadData, error: uploadErr } = await supabase.storage.from('documents').upload(filePath, file, { upsert: false });
      if (uploadErr) {
        // if file exists, try upsert true
        if (uploadErr.status === 409) {
          const { data: up, error: upErr } = await supabase.storage.from('documents').upload(filePath, file, { upsert: true });
          if (upErr) { console.error('Upload final error', upErr); return alert('Gagal upload: ' + upErr.message); }
        } else {
          console.error('Upload error', uploadErr);
          return alert('Gagal upload: ' + (uploadErr.message || JSON.stringify(uploadErr)));
        }
      }

      // get public URL (ensure /public/ path)
      let { data: urlData } = supabase.storage.from('documents').getPublicUrl(filePath);
      let publicUrl = urlData?.publicUrl || '';
      if (publicUrl && !publicUrl.includes('/public/')) {
        publicUrl = publicUrl.replace('/object/', '/object/public/');
      }

      // insert metadata (authenticated user allowed by policy)
      const { error: insertErr } = await supabase.from('documents').insert([{
        title, category, description, file_name: file.name, file_url: publicUrl
      }]);
      if (insertErr) {
        console.error('Insert error', insertErr);
        return alert('Gagal menyimpan metadata: ' + insertErr.message);
      }

      // reset and refresh
      fileInput.value = '';
      document.getElementById('title').value = '';
      document.getElementById('category').value = '';
      document.getElementById('description').value = '';
      alert('Dokumen berhasil di-upload!');
      loadDocuments();
    }

    // ====== Delete (admin only) ======
    async function deleteDocRow(id, fileName) {
      if (!confirm('Hapus dokumen ini?')) return;
      // delete storage object
      const { error: rmErr } = await supabase.storage.from('documents').remove([fileName]);
      if (rmErr) console.warn('Storage remove warning', rmErr);
      // delete db row
      const { error: delErr } = await supabase.from('documents').delete().eq('id', id);
      if (delErr) return alert('Gagal hapus row: ' + delErr.message);
      loadDocuments();
    }

    // ====== Load documents ======
    async function loadDocuments() {
      // fetch list
      const q = supabase.from('documents').select('*').order('created_at',{ascending:false});
      const { data, error } = await q;
      if (error) { console.error('Load error', error); listEl.innerHTML = '<div class="text-red-500">Gagal memuat dokumen.</div>'; return; }
      renderList(data || []);
    }

    function renderList(items) {
      const q = (searchEl.value || '').toLowerCase().trim();
      const filtered = items.filter(i => {
        if (!q) return true;
        return (i.title||'').toLowerCase().includes(q) || (i.description||'').toLowerCase().includes(q);
      });
      listEl.innerHTML = filtered.map(i => {
        // show delete button only if logged in
        const user = supabase.auth.getUser ? (supabase.auth.getUser()).then(()=>true).catch(()=>false) : null;
        // Build safe html
        return `
          <div class="flex justify-between items-start border p-3 rounded">
            <div>
              <div class="font-semibold">${escapeHtml(i.title)}</div>
              <div class="text-xs text-slate-500">${escapeHtml(i.category || '')} â€¢ ${i.created_at ? new Date(i.created_at).toLocaleString('id-ID') : ''}</div>
              <div class="text-sm text-slate-600 mt-1">${escapeHtml(i.description || '')}</div>
            </div>
            <div class="flex flex-col gap-2 items-end">
              <a class="text-indigo-600 hover:underline" href="${i.file_url}" target="_blank">Lihat</a>
              <!-- delete button rendered via onclick to ensure admin auth -->
              <button onclick="handleMaybeDelete('${i.id}','${i.file_name}')" class="text-red-600 text-sm">Hapus</button>
            </div>
          </div>
        `;
      }).join('') || '<div class="text-slate-500">Belum ada dokumen.</div>';
    }

    // helper: decide whether to actually delete (check user)
    async function handleMaybeDelete(id, fileName) {
      const user = (await supabase.auth.getUser()).data?.user;
      if (!user) return alert('Hanya admin yang dapat menghapus. Silakan login.');
      deleteDocRow(id, fileName);
    }

    // ==== events
    document.getElementById('btnUpload').onclick = uploadDocument;
    searchEl.addEventListener('input', () => loadDocuments());

    // ==== init: render auth status + load docs
    (async function init() {
      // check session
      const { data: { user } } = await supabase.auth.getUser().catch(()=>({ data:{ user:null } }));
      renderAuthUI(user);
      await loadDocuments();
    })();
  </script>
</body>
</html>
