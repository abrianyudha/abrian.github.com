<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Manajemen Dokumen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <h1 class="text-2xl font-bold mb-6 text-center">üìÅ Sistem Manajemen Dokumen</h1>

    <!-- Form Upload -->
    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-4">Upload Dokumen Baru</h2>
      <div class="grid gap-4">
        <input id="title" type="text" placeholder="Judul Dokumen" class="border p-2 rounded w-full" />
        <input id="category" type="text" placeholder="Kategori" class="border p-2 rounded w-full" />
        <textarea id="description" placeholder="Deskripsi" class="border p-2 rounded w-full"></textarea>
        <input id="file" type="file" class="border p-2 rounded w-full bg-white" />
        <button onclick="uploadDocument()" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
          Upload Dokumen
        </button>
      </div>
    </div>

    <!-- Daftar Dokumen -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-lg font-semibold mb-4">üìÑ Daftar Dokumen</h2>
      <div id="documentList" class="space-y-3"></div>
    </div>
  </div>

  <script>
    // GANTI dengan kredensial Supabase kamu
    const SUPABASE_URL = "https://axyqczuoklugkwqediaf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4eXFjenVva2x1Z2t3cWVkaWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTA1OTIsImV4cCI6MjA3Nzk4NjU5Mn0.JhVQShNjueYqdSAKJNy1uGmyfbc5s7bn_17IzZ-B718";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function uploadDocument() {
      const title = document.getElementById("title").value.trim();
      const category = document.getElementById("category").value.trim();
      const description = document.getElementById("description").value.trim();
      const fileInput = document.getElementById("file");
      const file = fileInput.files[0];

      if (!title || !category || !description || !file) {
        alert("Mohon isi semua field dan pilih file");
        return;
      }

      const filePath = `public/${Date.now()}_${file.name}`;
      console.log("Uploading:", filePath);

      // Upload ke Supabase Storage
      const { data, error: uploadErr } = await supabase.storage
        .from("documents")
        .upload(filePath, file, { upsert: true });

      if (uploadErr) {
        console.error("Upload Error:", uploadErr);
        alert("Gagal upload file: " + uploadErr.message);
        return;
      }

      // Ambil URL publik file
      const { data: publicUrlData } = supabase.storage
        .from("documents")
        .getPublicUrl(filePath);

      const fileUrl = publicUrlData.publicUrl;

      // Simpan metadata ke tabel documents
      const { error: insertErr } = await supabase
        .from("documents")
        .insert([
          {
            title,
            category,
            description,
            file_name: file.name,
            file_url: fileUrl,
          },
        ]);

      if (insertErr) {
        console.error("Database Error:", insertErr);
        alert("Gagal menyimpan data ke database: " + insertErr.message);
        return;
      }

      alert("‚úÖ Dokumen berhasil di-upload!");
      fileInput.value = "";
      document.getElementById("title").value = "";
      document.getElementById("category").value = "";
      document.getElementById("description").value = "";

      loadDocuments();
    }

    // Ambil semua dokumen dari database
    async function loadDocuments() {
      const { data, error } = await supabase
        .from("documents")
        .select("*")
        .order("created_at", { ascending: false });

      const list = document.getElementById("documentList");
      list.innerHTML = "";

      if (error) {
        list.innerHTML = `<p class="text-red-500">Gagal memuat dokumen.</p>`;
        console.error(error);
        return;
      }

      if (!data || data.length === 0) {
        list.innerHTML = `<p class="text-gray-500">Belum ada dokumen.</p>`;
        return;
      }

      data.forEach((doc) => {
        const div = document.createElement("div");
        div.className = "border p-4 rounded flex justify-between items-center";
        div.innerHTML = `
          <div>
            <h3 class="font-semibold">${doc.title}</h3>
            <p class="text-sm text-gray-600">${doc.category}</p>
            <p class="text-sm text-gray-500">${doc.description || ""}</p>
          </div>
          <a href="${doc.file_url}" target="_blank" class="text-blue-600 hover:underline">Lihat</a>
        `;
        list.appendChild(div);
      });
    }

    // Load dokumen saat halaman dibuka
    loadDocuments();
  </script>
</body>
</html>
